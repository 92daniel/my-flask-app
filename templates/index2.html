<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤§çœ¾é‹è¼¸æ¨è–¦è·¯ç·šæŸ¥è©¢</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
          integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI="
          crossorigin=""/>
    <style>
        #map-container {
            height: 600px;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            margin-top: 10px;
        }
        #map {
            height: 100%;
        }
        .transport-icon {
            font-size: 20px;
            margin-right: 5px;
        }
        .custom-marker {
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .route-leg {
            padding-left: 20px;
            border-left: 3px solid #dee2e6;
            margin-bottom: 15px;
        }
        .route-summary {
            background-color: #f8f9fa;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .route-details {
            background-color: #f8f9fa;
            border-radius: 5px;
            padding: 15px;
        }
        .direction-text {
            font-style: italic;
            color: #6c757d;
        }
        .map-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        .map-controls .btn {
            font-weight: bold;
            padding: 8px 15px;
        }
        #searchBtn {
            min-width: 100px;
        }
        #clearBtn {
            min-width: 100px;
        }
        .instruction-text {
            color: #6c757d;
            font-style: italic;
        }
    </style>
</head>
<body class="container py-4">
    <h2 class="text-center mb-4">ğŸš é«˜éµå‡ºç™¼ å…¬è»Šè·¯ç·šæ¨è–¦ç³»çµ±</h2>

    <div class="row">
        <div class="col">
            <div class="map-controls">
                <div class="instruction-text">è«‹å…ˆåœ¨åœ°åœ–ä¸Šé»é¸ç›®çš„åœ°ä½ç½®</div>
                <div>
                    <button id="searchBtn" class="btn btn-success" disabled>æœå°‹è·¯ç·š</button>
                    <button id="clearBtn" class="btn btn-outline-secondary ms-2">æ¸…é™¤å…¨éƒ¨</button>
                </div>
            </div>
            <div id="map-container">
                <div id="map"></div>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col">
            <div id="resultBox">
                <!-- çµæœå°‡åœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"
            integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM="
            crossorigin=""></script>
    <script>
        // åˆå§‹åŒ–åœ°åœ–
        const map = L.map('map').setView([24.808155, 121.040223], 14);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        // é«˜éµç«™åº§æ¨™
        const hsrStation = [24.80818, 121.0405];
        let selectedDestination = null;
        let destinationMarker = null;
        let routeLine = null;
        let routeMarkers = [];
        let startMarker = null;

        // æ·»åŠ é«˜éµç«™æ¨™è¨˜
        startMarker = L.marker(hsrStation, {
            icon: L.divIcon({
                className: 'start-marker',
                html: '<div style="font-size:20px;">ğŸš„</div><div>é«˜éµæ–°ç«¹ç«™</div>',
                iconSize: [40, 50],
                iconAnchor: [20, 50]
            }),
            zIndexOffset: 1000
        }).addTo(map);

        // åœ°åœ–é»æ“Šäº‹ä»¶
        map.on('click', function(e) {
            if (destinationMarker) map.removeLayer(destinationMarker);
            
            selectedDestination = e.latlng;
            destinationMarker = L.marker(e.latlng, {
                icon: L.divIcon({
                    className: 'destination-marker',
                    html: '<div style="font-size:20px;">ğŸ“</div><div>ç›®çš„åœ°</div>',
                    iconSize: [40, 50],
                    iconAnchor: [20, 50]
                }),
                zIndexOffset: 1000
            }).addTo(map);
            
            document.getElementById("searchBtn").disabled = false;
            
            // æ›´æ–°æç¤ºæ–‡å­—
            document.querySelector(".instruction-text").textContent = "å·²é¸æ“‡ç›®çš„åœ°ï¼Œè«‹é»æ“Šã€Œæœå°‹è·¯ç·šã€";
        });

        // æ¸…é™¤å…¨éƒ¨æŒ‰éˆ•
        document.getElementById("clearBtn").addEventListener("click", function() {
            if (routeLine) map.removeLayer(routeLine);
            routeMarkers.forEach(marker => map.removeLayer(marker));
            routeMarkers = [];
            
            if (destinationMarker) {
                map.removeLayer(destinationMarker);
                destinationMarker = null;
            }
            
            document.getElementById("resultBox").innerHTML = '';
            document.getElementById("searchBtn").disabled = true;
            selectedDestination = null;
            map.setView([24.808155, 121.040223], 14);
            
            // é‡ç½®æç¤ºæ–‡å­—
            document.querySelector(".instruction-text").textContent = "è«‹å…ˆåœ¨åœ°åœ–ä¸Šé»é¸ç›®çš„åœ°ä½ç½®";
        });

        // æœå°‹è·¯ç·šæŒ‰éˆ•
        document.getElementById("searchBtn").addEventListener("click", function() {
            if (!selectedDestination) {
                alert("è«‹å…ˆåœ¨åœ°åœ–ä¸Šé»é¸ç›®çš„åœ°");
                return;
            }

            const lat = selectedDestination.lat;
            const lng = selectedDestination.lng;
            
            document.getElementById("resultBox").innerHTML = `
                <div class="d-flex justify-content-center align-items-center" style="height: 200px;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <span class="ms-3">æ­£åœ¨æœå°‹æœ€ä½³è·¯ç·š...</span>
                </div>
            `;

            fetch("/get_route", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ lat, lng })
            })
            .then(response => {
                if (!response.ok) throw new Error("ç„¡æ³•å–å¾—è·¯ç·šè³‡æ–™");
                return response.json();
            })
            .then(data => {
                if (!data.success) throw new Error(data.message || "è·¯ç·šæœå°‹å¤±æ•—");
                displayResults(data);
            })
            .catch(error => {
                document.getElementById("resultBox").innerHTML = `
                    <div class="alert alert-danger">
                        <strong>éŒ¯èª¤</strong>
                        <div>${error.message}</div>
                    </div>
                `;
            });
        });

        // é¡¯ç¤ºçµæœå‡½æ•¸
        function displayResults(data) {
            // æ¸…é™¤èˆŠè·¯ç·š
            if (routeLine) map.removeLayer(routeLine);
            routeMarkers.forEach(marker => map.removeLayer(marker));
            routeMarkers = [];
            
            // ç¹ªè£½æ–°è·¯ç·š
            drawRoute(data.ç¶“ç·¯åº¦è·¯å¾‘);
            
            // ç”Ÿæˆçµæœé¡¯ç¤º
            const box = document.getElementById("resultBox");
            
            // ç°¡æ˜“è·¯ç·š - åªé¡¯ç¤ºèµ·è¨–é»å’Œæ–¹å‘
            let simplifiedHTML = `
                <div class="route-summary">
                    <h4 class="mb-3">ç°¡æ˜“è·¯ç·š</h4>
                    <div class="d-flex mb-3">
                        <span class="badge bg-primary me-2">ç¸½è€—æ™‚: ${data.ç¸½è€—æ™‚ || "æœªçŸ¥"}</span>
                        <span class="badge bg-primary">åˆ°é”æ™‚é–“: ${data.åˆ°é”æ™‚é–“ || "æœªçŸ¥"}</span>
                    </div>
            `;
            
            // å¾è©³ç´°è·¯ç·šæå–æ–¹å‘è³‡è¨Š
            if (data.è©³ç´°è·¯ç·š && data.è©³ç´°è·¯ç·š.length > 0) {
                const routeSegments = groupRouteSegments(data.è©³ç´°è·¯ç·š);
                
                routeSegments.forEach(segment => {
                    simplifiedHTML += `
                        <div class="route-leg mb-3">
                            <div class="fw-bold">${segment.mode}</div>
                            <div class="direction-text">
                                ${segment.from} â†’ ${segment.to}
                                ${segment.time ? `<span class="ms-2">(${segment.time})</span>` : ''}
                            </div>
                        </div>
                    `;
                });
            }
            
            simplifiedHTML += `</div>`;
            
            // è©³ç´°è·¯ç·š
            let detailedHTML = `
                <div class="route-details mt-4">
                    <h4 class="mb-3">è©³ç´°è·¯ç·š</h4>
                    <div class="list-group">
            `;
            
            data.è©³ç´°è·¯ç·š.forEach((step, index) => {
                if (!step || step.length < 2) return;
                
                let icon;
                if (step[0] === "èµ°è·¯") icon = "ğŸš¶â€â™‚ï¸";
                else if (step[0] === "æ­¥è¡Œè½‰ä¹˜") icon = "ğŸ‘£";
                else if (step[0] === "æŠµé”") icon = "âœ…";
                else if (step[0].includes("é«˜éµ") || step[0].includes("ç«è»Š")) icon = "ğŸš„";
                else icon = "ğŸšŒ";
                
                detailedHTML += `
                    <div class="list-group-item">
                        <div class="d-flex align-items-center">
                            <span class="transport-icon">${icon}</span>
                            <div>
                                <strong>${step[0]}</strong> â†’ ${step[1]}
                                ${step[2] ? `<div class="text-muted small">æ™‚é–“: ${step[2]}</div>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            detailedHTML += `</div></div>`;
            
            box.innerHTML = simplifiedHTML + detailedHTML;
        }

        // ç¹ªè£½è·¯ç·šå‡½æ•¸ï¼ˆä½¿ç”¨ä¸åŒåœ–æ¨™ï¼‰
        function drawRoute(coordinates) {
            if (!coordinates || coordinates.length === 0) return;
            
            // å¾é«˜éµç«™é–‹å§‹çš„è·¯ç·š
            const fullPath = [
                { lat: hsrStation[0], lng: hsrStation[1], stop: "é«˜éµæ–°ç«¹ç«™", mode: "é«˜éµ" },
                ...coordinates
            ];
            
            // ç¹ªè£½è·¯ç·š
            routeLine = L.polyline(
                fullPath.map(p => [p.lat, p.lng]), 
                { color: '#0d6efd', weight: 5 }
            ).addTo(map);
            
            // æ·»åŠ ç«™é»æ¨™è¨˜
            fullPath.forEach((point, index) => {
                if (index === 0) return; // è·³éé«˜éµç«™
                
                let iconHtml;
                const isTransfer = point.mode === "æ­¥è¡Œè½‰ä¹˜" || point.mode === "èµ°è·¯";
                const isDestination = point.mode === "æŠµé”";
                
                if (isTransfer) {
                    iconHtml = '<div style="background:#6c757d;color:white;border-radius:50%;width:20px;height:20px;display:flex;align-items:center;justify-content:center;">ğŸš¶</div>';
                } else if (isDestination) {
                    iconHtml = '<div style="background:#28a745;color:white;border-radius:50%;width:20px;height:20px;display:flex;align-items:center;justify-content:center;">âœ“</div>';
                } else if (point.mode.includes("é«˜éµ") || point.mode.includes("ç«è»Š")) {
                    iconHtml = '<div style="background:#dc3545;color:white;border-radius:50%;width:20px;height:20px;display:flex;align-items:center;justify-content:center;">ğŸš„</div>';
                } else {
                    // å…¬è»Šæˆ–å…¶ä»–äº¤é€šå·¥å…·
                    iconHtml = `<div style="background:#17a2b8;color:white;border-radius:50%;width:20px;height:20px;display:flex;align-items:center;justify-content:center;">${index}</div>`;
                }
                
                const marker = L.marker([point.lat, point.lng], {
                    icon: L.divIcon({
                        className: 'custom-marker',
                        html: iconHtml,
                        iconSize: [24, 24],
                        iconAnchor: [12, 12]
                    })
                }).addTo(map);
                
                // æ·»åŠ æç¤ºæ¡†
                marker.bindTooltip(`
                    <div class="text-center">
                        <div><strong>${point.stop || point.mode}</strong></div>
                        ${point.time ? `<div>æ™‚é–“: ${point.time}</div>` : ''}
                    </div>
                `);
                
                routeMarkers.push(marker);
            });
            
            // èª¿æ•´åœ°åœ–è¦–é‡
            const bounds = L.latLngBounds(fullPath.map(p => [p.lat, p.lng]));
            if (selectedDestination) bounds.extend([selectedDestination.lat, selectedDestination.lng]);
            map.fitBounds(bounds, { padding: [50, 50] });
        }

        // åˆ†çµ„è·¯ç·šæ®µè½ï¼ˆç”¨æ–¼ç°¡æ˜“è·¯ç·šé¡¯ç¤ºï¼‰
        function groupRouteSegments(steps) {
            const segments = [];
            let currentSegment = null;
            
            for (let i = 0; i < steps.length; i++) {
                const step = steps[i];
                if (!step || step.length < 2) continue;
                
                if (step[0] === "æ­¥è¡Œè½‰ä¹˜" || step[0] === "èµ°è·¯") {
                    // å¦‚æœæ˜¯æ­¥è¡Œä¸”ä¸‹ä¸€å€‹æ˜¯äº¤é€šå·¥å…·ï¼Œå‰‡åˆä½µ
                    if (i < steps.length - 1 && steps[i+1] && steps[i+1].length >= 2 && 
                        !["æ­¥è¡Œè½‰ä¹˜", "èµ°è·¯", "æŠµé”"].includes(steps[i+1][0])) {
                        continue; // è·³éæ­¥è¡Œï¼Œæœƒåœ¨è™•ç†äº¤é€šå·¥å…·æ™‚åˆä½µ
                    } else {
                        // å–®ç¨çš„æ­¥è¡Œæ®µè½
                        segments.push({
                            mode: "æ­¥è¡Œ",
                            from: step[1],
                            to: step[1],
                            time: step[2]
                        });
                    }
                } else if (step[0] === "æŠµé”") {
                    // å¿½ç•¥æŠµé”æ­¥é©Ÿ
                    continue;
                } else {
                    // äº¤é€šå·¥å…·æ®µè½
                    const segment = {
                        mode: step[0],
                        from: step[1],
                        to: step[1],
                        time: step[2]
                    };
                    
                    // æª¢æŸ¥å‰é¢æ˜¯å¦æœ‰æ­¥è¡Œå¯ä»¥åˆä½µ
                    if (i > 0 && (steps[i-1][0] === "æ­¥è¡Œè½‰ä¹˜" || steps[i-1][0] === "èµ°è·¯")) {
                        segment.from = steps[i-1][1];
                    }
                    
                    // æª¢æŸ¥å¾Œé¢æ˜¯å¦æœ‰é€£çºŒçš„åŒä¸€äº¤é€šå·¥å…·
                    while (i < steps.length - 1 && steps[i+1] && steps[i+1][0] === step[0]) {
                        i++;
                        segment.to = steps[i][1];
                        segment.time = steps[i][2];
                    }
                    
                    segments.push(segment);
                }
            }
            
            return segments;
        }
    </script>
</body>
</html>