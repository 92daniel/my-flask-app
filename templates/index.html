<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>å¤§çœ¾é‹è¼¸æ¨è–¦è·¯ç·šæŸ¥è©¢</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
    <style>
        #map { height: 500px; }
        .info-box { margin-top: 1rem; }
    </style>
</head>
<body class="container py-4">
    <h2>ğŸš é«˜éµå‡ºç™¼ å…¬è»Šè·¯ç·šæ¨è–¦ç³»çµ±</h2>

    <div class="row mt-3">
        <div class="col-md-6">
            <label for="timeSelect" class="form-label"><strong>è«‹é¸æ“‡å‡ºç™¼æ™‚é–“ï¼ˆ04:00 ï½ 23:55ï¼Œæ¯ 5 åˆ†ï¼‰</strong></label>
            <select id="timeSelect" class="form-select mb-2">
                <option value="">-- é¸æ“‡æ™‚é–“ --</option>
            </select>
            <button id="nowBtn" class="btn btn-outline-primary btn-sm">ä½¿ç”¨ç›®å‰æ™‚é–“</button>
        </div>
    </div>

    <div class="row mt-3">
        <div class="col">
            <div id="map"></div>
        </div>
    </div>

    <div class="row mt-3">
        <div class="col">
            <button id="searchBtn" class="btn btn-success" disabled>ğŸ” æœå°‹æ¨è–¦è·¯ç·š</button>
        </div>
    </div>

    <div class="info-box" id="resultBox"></div>

    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
    <script>
        const map = L.map('map').setView([24.808155, 121.040223], 13);
        const markerGroup = L.layerGroup().addTo(map);
        let selectedDestination = null;

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        // å»ºç«‹ 5 åˆ†é˜ç‚ºå–®ä½çš„æ™‚é–“ä¸‹æ‹‰é¸å–®
        const timeSelect = document.getElementById("timeSelect");
        for (let h = 4; h < 24; h++) {
            for (let m = 0; m < 60; m += 10) {
                const hh = h.toString().padStart(2, '0');
                const mm = m.toString().padStart(2, '0');
                const t = `${hh}:${mm}`;
                const opt = document.createElement("option");
                opt.value = t;
                opt.innerText = t;
                timeSelect.appendChild(opt);
            }
        }

        // ä½¿ç”¨ç¾åœ¨æ™‚é–“
        document.getElementById("nowBtn").addEventListener("click", () => {
            const now = new Date();
            const hh = now.getHours().toString().padStart(2, '0');
            const mm = Math.floor(now.getMinutes() / 10) * 10;
            const mmStr = mm.toString().padStart(2, '0');
            timeSelect.value = `${hh}:${mmStr}`;
            updateSearchButtonState();
        });

        // é»åœ°åœ–é¸ç›®çš„åœ°
        map.on('click', function(e) {
            markerGroup.clearLayers();
            const marker = L.marker(e.latlng).addTo(markerGroup);
            selectedDestination = e.latlng;
            updateSearchButtonState();
        });

        // æ ¹æ“šé¸é …å•Ÿç”¨/åœç”¨æœå°‹æŒ‰éˆ•
        function updateSearchButtonState() {
            document.getElementById("searchBtn").disabled = !(selectedDestination && timeSelect.value);
        }
        timeSelect.addEventListener("change", updateSearchButtonState);

        // æŸ¥è©¢æŒ‰éˆ•é»æ“Š
        document.getElementById("searchBtn").addEventListener("click", () => {
            if (!selectedDestination || !timeSelect.value) return;
            const lat = selectedDestination.lat;
            const lon = selectedDestination.lng;
            const time = timeSelect.value;

            fetch("/get_route", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ lat, lon, time })
            })
            .then(res => res.json())
            .then(data => {
                const box = document.getElementById("resultBox");
                if (!data.success) {
                    box.innerHTML = `<div class="alert alert-danger">${data.message}</div>`;
                    return;
                }

                // é¡¯ç¤ºç°¡ç•¥è·¯ç·šèˆ‡åˆ°é”æ™‚é–“
                let html = `<div class="card"><div class="card-body">`;
                html += `<h5 class="card-title">ğŸš æ¨è–¦è·¯ç·šï¼ˆç¸½è€—æ™‚ï¼š${data.ç¸½è€—æ™‚}ï¼Œåˆ°é”æ™‚é–“ï¼š${data.åˆ°é”æ™‚é–“}ï¼‰</h5>`;
                html += `<ul class="list-group list-group-flush">`;
                data.ç°¡ç•¥è·¯ç·š.forEach(item => {
                    if (item[0] === "èµ°è·¯" || item[0] === "æ­¥è¡Œè½‰ä¹˜") {
                        html += `<li class="list-group-item">ğŸš¶â€â™‚ï¸ ${item[0]} â†’ ${item[1]}</li>`;
                    } else if (item[0] === "æŠµé”") {
                        html += `<li class="list-group-item">âœ… æŠµé”ç›®çš„åœ°ï¼š${item[1]}</li>`;
                    } else {
                        html += `<li class="list-group-item">ğŸšŒ æ­ä¹˜ ${item[0]}ï¼š${item[1]} ${item[2] || ""}</li>`;
                    }
                });
                html += `</ul></div></div>`;
                box.innerHTML = html;

                // åœ¨åœ°åœ–ç•«å‡ºç¶“ç·¯åº¦è·¯å¾‘
                if (window.routeLine) {
                    map.removeLayer(window.routeLine);
                }
                const latlngs = data.ç¶“ç·¯åº¦è·¯å¾‘.map(p => [p.lat, p.lng]);
                window.routeLine = L.polyline(latlngs, { color: 'blue' }).addTo(map);
                map.fitBounds(window.routeLine.getBounds(), { padding: [50, 50] });
            });
        });
    </script>
</body>
</html>
